"use strict";(self.webpackChunksc_depot=self.webpackChunksc_depot||[]).push([[305],{30305:(e,t,a)=>{a.r(t),a.d(t,{CIMSymbolRasterizer:()=>_});var i=a(69539),r=a(3825),n=a(50346),s=a(76931),o=a(5139),l=a(85504),c=a(16770);class h{constructor(){this._resourceMap=new Map,this._inFlightResourceMap=new Map,this.geometryEngine=null,this.geometryEnginePromise=null}destroy(){this._inFlightResourceMap.clear(),this._resourceMap.clear()}getResource(e){var t;return null!==(t=this._resourceMap.get(e))&&void 0!==t?t:null}async fetchResource(e,t){const a=this._resourceMap.get(e);if(a)return{width:a.width,height:a.height};let i=this._inFlightResourceMap.get(e);return i?i.then((e=>({width:e.width,height:e.height}))):(i=(0,c.M5)(e,t),this._inFlightResourceMap.set(e,i),i.then((t=>(this._inFlightResourceMap.delete(e),this._resourceMap.set(e,t),{width:t.width,height:t.height})),(()=>({width:0,height:0}))))}deleteResource(e){this._inFlightResourceMap.delete(e),this._resourceMap.delete(e)}loadFont(e){return(0,l.Al)(e)}}var m=a(17764),g=a(401),u=a(15941),d=a(83367),f=a(99382),y=a(72813),p=a(97763);class w{constructor(e){this._resourceManager=e,this._lazyRasterizationCanvas=null}dispose(){this._lazyRasterizationCanvas=null}get _rasterizationCanvas(){return null==this._lazyRasterizationCanvas&&(this._lazyRasterizationCanvas=document.createElement("canvas"),this._lazyRasterizationCanvas.getContext("2d",{willReadFrequently:!0})),this._lazyRasterizationCanvas}rasterizeJSONResource(e,t,a){if("simple-fill"===e.type||"esriSFS"===e.type){const[a,i,r]=(0,d.r)(this._rasterizationCanvas,e.style,t);return{size:[i,r],image:new Uint32Array(a.buffer),sdf:!1,simplePattern:!0,anchorX:0,anchorY:0,rasterizationScale:(0,u.yR)(Math.ceil(t))}}if("simple-line"===e.type||"esriSLS"===e.type||"line"===e.type&&e.dashTemplate){let t,a;if("simple-line"===e.type||"esriSLS"===e.type)switch(t=(0,g.BW)(e.style,e.cap),e.cap){case"butt":a="Butt";break;case"square":a="Square";break;default:a="Round"}else t=e.dashTemplate,a=e.cim.capStyle;const[i,r,n]=(0,d.k)(t,a);return{size:[r,n],image:new Uint32Array(i.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}}let i,r=null,n=null,s=1;if("simple-marker"===e.type||"esriSMS"===e.type||"line-marker"===e.type?(i=g.wp.fromSimpleMarker(e),n=(0,y.eR)(i)):e.cim&&"CIMHatchFill"===e.cim.type?(i=g.wp.fromCIMHatchFill(e.cim,t),r=new f.A(i.frame.xmin,-i.frame.ymax,i.frame.xmax-i.frame.xmin,i.frame.ymax-i.frame.ymin),s=t):e.cim.markerPlacement&&"CIMMarkerPlacementInsidePolygon"===e.cim.markerPlacement.type?(i=g.wp.fromCIMInsidePolygon(e.cim),r=new f.A(i.frame.xmin,-i.frame.ymax,i.frame.xmax-i.frame.xmin,i.frame.ymax-i.frame.ymin)):(i=e.cim,e.avoidSDFRasterization||(n=(0,y.eR)(i))),n&&!a){const[e,t,a]=(0,y.ce)(n);return e?{size:[t,a],image:new Uint32Array(e.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0,rasterizationScale:s}:null}const[o,l,c,h,m]=g.wp.rasterize(this._rasterizationCanvas,i,r,this._resourceManager,!a);return o?{size:[l,c],image:new Uint32Array(o.buffer),sdf:!1,simplePattern:!1,anchorX:h,anchorY:m}:null}rasterizeImageResource(e,t,a,i){this._rasterizationCanvas.width=e,this._rasterizationCanvas.height=t;const r=this._rasterizationCanvas.getContext("2d");a instanceof ImageData?r.putImageData(a,0,0):(a.setAttribute("width","".concat(e,"px")),a.setAttribute("height","".concat(t,"px")),r.drawImage(a,0,0,e,t));const n=r.getImageData(0,0,e,t),s=new Uint8Array(n.data);if(i)for(const g of i)if(g&&g.oldColor&&4===g.oldColor.length&&g.newColor&&4===g.newColor.length){const[e,t,a,i]=g.oldColor,[r,n,o,l]=g.newColor;if(e===r&&t===n&&a===o&&i===l)continue;for(let c=0;c<s.length;c+=4)e===s[c]&&t===s[c+1]&&a===s[c+2]&&i===s[c+3]&&(s[c]=r,s[c+1]=n,s[c+2]=o,s[c+3]=l)}let o;for(let g=0;g<s.length;g+=4)o=s[g+3]/255,s[g]=s[g]*o,s[g+1]=s[g+1]*o,s[g+2]=s[g+2]*o;let l=s,c=e,h=t;const m=512;if(c>=m||h>=m){const a=c/h;a>1?(c=m,h=Math.round(m/a)):(h=m,c=Math.round(m*a)),l=new Uint8Array(4*c*h);const i=new Uint8ClampedArray(l.buffer);(0,p.Go)(s,e,t,i,c,h,!1)}return{size:[c,h],image:new Uint32Array(l.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}}var C=a(62706),z=a(29632),M=a(93223);const v=e=>null!==e&&void 0!==e&&e.scaleFactor?e.scaleFactor:1;class _{constructor(e,t){this._spatialReference=e,this._avoidSDF=t,this._resourceCache=new Map,this._lazyImageDataCanvas=null,this._pictureMarkerCache=new Map,this._textRasterizer=new C.A,this._cimResourceManager=new h,this._rasterizer=new w(this._cimResourceManager)}get _imageDataCanvas(){var e;return null!==(e=this._lazyImageDataCanvas)&&void 0!==e||(this._lazyImageDataCanvas=document.createElement("canvas")),this._lazyImageDataCanvas}get _imageDataContext(){return this._imageDataCanvas.getContext("2d",{willReadFrequently:!0})}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(e,t,a,i,r,n,s,o,l){if(!e)return null;const{data:c}=e;if(!c||"CIMSymbolReference"!==c.type||!c.symbol)return null;const{symbol:h}=c;n||(n=(0,p.n5)(h));const u=await g.$N.resolveSymbolOverrides(c,t,this._spatialReference,r,n,s,o),d=this._imageDataCanvas,f=this._cimResourceManager,y=[];g.wp.fetchResources(u,f,y),g.wp.fetchFonts(u,f,y),y.length>0&&await Promise.all(y);const{width:w,height:C}=a,z=function(e,t,a,i){const r=1,n=-t/2+r,s=t/2-r,o=a/2-r,l=-a/2+r;switch(e){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[n,0],[0,0],[s,0]]]};default:return"legend"===i?{rings:[[[n,o],[s,0],[s,l],[n,l],[n,o]]]}:{rings:[[[n,o],[s,o],[s,l],[n,l],[n,o]]]}}}(n,w,C,i),M=g.wp.getEnvelope(u,z,f);if(!M)return null;const v=1.3333333333333333*(window.devicePixelRatio||1);let _=1,S=0,R=0;switch(h.type){case"CIMPointSymbol":case"CIMTextSymbol":{let e=1;M.width>w&&(e=w/M.width);let t=1;M.height>C&&(t=C/M.height),"preview"===i&&(M.width<w&&(e=w/M.width),M.height<C&&(t=C/M.height)),_=Math.min(e,t),S=M.x+M.width/2,R=M.y+M.height/2}break;case"CIMLineSymbol":{(l||M.height>C)&&(_=C/M.height),R=M.y+M.height/2;const e=M.x*_+w/2,t=(M.x+M.width)*_+w/2,{paths:a}=z;a[0][0][0]-=e/_,a[0][2][0]-=(t-w)/_}break;case"CIMPolygonSymbol":{S=M.x+M.width/2,R=M.y+M.height/2;const e=M.x*_+w/2,t=(M.x+M.width)*_+w/2,a=M.y*_+C/2,i=(M.y+M.height)*_+C/2,{rings:r}=z;e<0&&(r[0][0][0]-=e,r[0][3][0]-=e,r[0][4][0]-=e),a<0&&(r[0][0][1]+=a,r[0][1][1]+=a,r[0][4][1]+=a),t>w&&(r[0][1][0]-=t-w,r[0][2][0]-=t-w),i>C&&(r[0][2][1]+=i-C,r[0][3][1]+=i-C)}}d.width=w*v,d.height=C*v;d.width+=2,d.height+=2;const x=this._imageDataContext,b=m.IT.createIdentity();return b.translate(-S,-R),b.scale(_*v,-_*v),b.translate(w*v/2+1,C*v/2+1),x.clearRect(0,0,d.width,d.height),new m.Rj(x,f,b,!0).drawSymbol(u,z),x.getImageData(0,0,d.width,d.height)}async analyzeCIMSymbol3D(e,t,a,i,r){const s=[],l=t?{geometryType:i,spatialReference:this._spatialReference,fields:t}:null,c=[];g.wp.fetchFonts(e.data.symbol,this._cimResourceManager,c),await Promise.all(c);const h=new o.U(this._cimResourceManager,l);let m;await h.analyzeSymbolReference(e.data,this._avoidSDF,s),(0,n.Te)(r);for(const n of s)"CIMPictureMarker"!==n.cim.type&&"CIMPictureFill"!==n.cim.type&&"CIMPictureStroke"!==n.cim.type||(m||(m=[]),m.push(this._fetchPictureMarkerResource(n,r))),a&&"text"===n.type&&"string"==typeof n.text&&n.text.includes("[")&&(n.text=(0,p.P3)(a,n.text,n.cim.textCase));return m&&await Promise.all(m),s}rasterizeCIMSymbol3D(e,t,a,i,r,n){const s=[];for(const l of e){i&&"function"==typeof i.scaleFactor&&(i.scaleFactor=i.scaleFactor(t,r,n));const e=this._getRasterizedResource(l,t,a,i,r,n);if(!e)continue;let c=0,h=e.anchorX||0,m=e.anchorY||0,g=!1,u=0,d=0;if("esriGeometryPoint"===a){var o;const e=v(i);if(u=(0,p.s4)(l.offsetX,t,r,n)*e||0,d=(0,p.s4)(l.offsetY,t,r,n)*e||0,"marker"===l.type)c=(0,p.s4)(l.rotation,t,r,n)||0,g=null!==(o=l.rotateClockwise)&&void 0!==o&&o;else if("text"===l.type){if(c=(0,p.s4)(l.angle,t,r,n)||0,void 0!==l.horizontalAlignment)switch(l.horizontalAlignment){case"left":h=-.5;break;case"right":h=.5;break;default:h=0}if(void 0!==l.verticalAlignment)switch(l.verticalAlignment){case"top":m=.5;break;case"bottom":m=-.5;break;case"baseline":m=-.25;break;default:m=0}}}null!=e&&s.push({angle:c,rotateClockWise:g,anchorX:h,anchorY:m,offsetX:u,offsetY:d,rasterizedResource:e})}return this.getSymbolImage(s)}getSymbolImage(e){const t=document.createElement("canvas"),a=t.getContext("2d");let i=0,r=0,n=0,o=0;const l=[];for(let g=0;g<e.length;g++){const t=e[g],c=t.rasterizedResource;if(!c)continue;const h=c.size,m=t.offsetX,u=t.offsetY,d=t.anchorX,f=t.anchorY,y=t.rotateClockWise||!1;let p=t.angle,w=(0,s.Lz)(m)-h[0]*(.5+d),C=(0,s.Lz)(u)-h[1]*(.5+f),z=w+h[0],M=C+h[1];if(p){y&&(p=-p);const e=Math.sin(p*Math.PI/180),t=Math.cos(p*Math.PI/180),a=w*t-C*e,i=w*e+C*t,r=w*t-M*e,n=w*e+M*t,s=z*t-M*e,o=z*e+M*t,l=z*t-C*e,c=z*e+C*t;w=Math.min(a,r,s,l),C=Math.min(i,n,o,c),z=Math.max(a,r,s,l),M=Math.max(i,n,o,c)}i=w<i?w:i,r=C<r?C:r,n=z>n?z:n,o=M>o?M:o;const v=a.createImageData(c.size[0],c.size[1]);v.data.set(new Uint8ClampedArray(c.image.buffer));const _={offsetX:m,offsetY:u,rotateClockwise:y,angle:p,rasterizedImage:v,anchorX:d,anchorY:f};l.push(_)}t.width=n-i,t.height=o-r;const c=-i,h=o;for(let g=0;g<l.length;g++){const e=l[g],t=this._imageDataToCanvas(e.rasterizedImage),i=e.rasterizedImage.width,r=e.rasterizedImage.height,n=c-i*(.5+e.anchorX),o=h-r*(.5-e.anchorY);if(e.angle){const i=(360-e.angle)*Math.PI/180;a.save(),a.translate((0,s.Lz)(e.offsetX),-(0,s.Lz)(e.offsetY)),a.translate(c,h),a.rotate(i),a.translate(-c,-h),a.drawImage(t,n,o),a.restore()}else a.drawImage(t,n+(0,s.Lz)(e.offsetX),o-(0,s.Lz)(e.offsetY))}const m=new M.Q({x:c/t.width-.5,y:h/t.height-.5});return{imageData:0!==t.width&&0!==t.height?a.getImageData(0,0,t.width,t.height):a.createImageData(1,1),anchorPosition:m}}async _fetchPictureMarkerResource(e,t){const a=e.materialHash;if(!this._pictureMarkerCache.get(a)){const i=(await(0,r.A)(e.cim.url,{responseType:"image",signal:null===t||void 0===t?void 0:t.signal})).data;this._pictureMarkerCache.set(a,i)}}_imageDataToCanvas(e){const t=this._imageDataCanvas,a=this._imageDataContext;return t.width=e.width,t.height=e.height,a.putImageData(e,0,0),t}_imageTo32Array(e,t,a,r){const n=this._imageDataCanvas,s=this._imageDataContext;if(n.width=t,n.height=a,s.drawImage(e,0,0,t,a),r){s.save();const n=new i.A(r);s.fillStyle=n.toHex(),s.globalCompositeOperation="multiply",s.fillRect(0,0,t,a),s.globalCompositeOperation="destination-atop",s.drawImage(e,0,0,t,a),s.restore()}return new Uint32Array(s.getImageData(0,0,t,a).data.buffer)}_getRasterizedResource(e,t,a,i,r,n){let s,l,c;if("text"===e.type)return this._rasterizeTextResource(e,t,i,r,n);({analyzedCIM:s,hash:l}=function(e,t,a,i){let r,n;"function"==typeof e.materialHash?(r=(0,e.materialHash)(t,a,i),n=(0,o.G)(e.cim,e.materialOverrides)):(r=e.materialHash,n=e.cim);return{analyzedCIM:n,hash:r}}(e,t,r,n));const h=v(i);if("CIMPictureMarker"===e.cim.type){const a=(0,p.s4)(e.size,t,r,n)*h,{image:i,width:s,height:o}=this._getPictureResource(e,a,(0,p.s4)(e.color,t,r,n));return c={image:i,size:[s,o],sdf:!1,simplePattern:!1,anchorX:e.anchorPoint?e.anchorPoint.x:0,anchorY:e.anchorPoint?e.anchorPoint.y:0},c}(0,z.mR)(s,h,{preserveOutlineWidth:!1});const m=s;l+=a,i&&(l+=JSON.stringify(i));const g=this._resourceCache;return g.has(l)?g.get(l):(c=this._rasterizer.rasterizeJSONResource({cim:m,type:e.type,url:e.url,mosaicHash:l,size:null,path:null},window.devicePixelRatio||1,this._avoidSDF),g.set(l,c),c)}_rasterizeTextResource(e,t,a,i,r){var n,s,o;const l=v(a),c=(0,p.s4)(e.text,t,i,r);if(!c||0===c.length)return null;const h=e.cim,m=(0,p.s4)((null===h||void 0===h?void 0:h.fontFamilyName)||e.fontName,t,i,r),g=(0,p.s4)((null===h||void 0===h||null===(n=h.font)||void 0===n?void 0:n.style)||e.style,t,i,r),u=(0,p.s4)((null===h||void 0===h||null===(s=h.font)||void 0===s?void 0:s.weight)||e.weight,t,i,r),d=(0,p.s4)((null===h||void 0===h||null===(o=h.font)||void 0===o?void 0:o.decoration)||e.decoration,t,i,r),f=(0,p.s4)(e.size,t,i,r)*l,y=(0,p.s4)(e.horizontalAlignment,t,i,r),w=(0,p.s4)(e.verticalAlignment,t,i,r),C=(0,p.G9)((0,p.s4)(e.color,t,i,r)),z=(0,p.G9)((0,p.s4)(e.outlineColor,t,i,r)),M=(0,p.s4)(e.outlineSize,t,i,r),_=null!=e.backgroundColor?(0,p.G9)(e.backgroundColor):null,S=null!=e.borderLineColor?(0,p.G9)(e.borderLineColor):null,R=null!=e.borderLineWidth?e.borderLineWidth:null,x={color:C,size:f,horizontalAlignment:y,verticalAlignment:w,font:{family:m,style:g,weight:u,decoration:d},halo:{size:M||0,color:z,style:g},backgroundColor:_,borderLine:null!=S&&null!=R?{color:S,size:R}:null,pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(c,x)}_getPictureResource(e,t,a){const i=this._pictureMarkerCache.get(e.materialHash);if(!i)return null;const r=i.height/i.width,n=t?r>1?(0,s.Lz)(t):(0,s.Lz)(t)/r:i.width,o=t?r>1?(0,s.Lz)(t)*r:(0,s.Lz)(t):i.height;return{image:this._imageTo32Array(i,n,o,a),width:n,height:o}}}},83367:(e,t,a)=>{a.d(t,{k:()=>o,r:()=>s});var i=a(14522),r=a(15941);const n=e=>"vertical"===e||"horizontal"===e||"cross"===e||"esriSFSCross"===e||"esriSFSVertical"===e||"esriSFSHorizontal"===e;function s(e,t,a){const i=(0,r.yR)(Math.ceil(a)),s=n(t)?8*i:16*i,o=2*i;e.width=s,e.height=s;const l=e.getContext("2d");l.strokeStyle="#FFFFFF",l.lineWidth=i,l.beginPath(),"vertical"!==t&&"cross"!==t&&"esriSFSCross"!==t&&"esriSFSVertical"!==t||(l.moveTo(s/2,-o),l.lineTo(s/2,s+o)),"horizontal"!==t&&"cross"!==t&&"esriSFSCross"!==t&&"esriSFSHorizontal"!==t||(l.moveTo(-o,s/2),l.lineTo(s+o,s/2)),"forward-diagonal"!==t&&"diagonal-cross"!==t&&"esriSFSDiagonalCross"!==t&&"esriSFSForwardDiagonal"!==t||(l.moveTo(-o,-o),l.lineTo(s+o,s+o),l.moveTo(s-o,-o),l.lineTo(s+o,o),l.moveTo(-o,s-o),l.lineTo(o,s+o)),"backward-diagonal"!==t&&"diagonal-cross"!==t&&"esriSFSBackwardDiagonal"!==t&&"esriSFSDiagonalCross"!==t||(l.moveTo(s+o,-o),l.lineTo(-o,s+o),l.moveTo(o,-o),l.lineTo(-o,o),l.moveTo(s+o,s-o),l.lineTo(s-o,s+o)),l.stroke();const c=l.getImageData(0,0,e.width,e.height),h=new Uint8Array(c.data);let m;for(let r=0;r<h.length;r+=4)m=h[r+3]/255,h[r]=h[r]*m,h[r+1]=h[r+1]*m,h[r+2]=h[r+2]*m;return[h,e.width,e.height]}function o(e,t){const a="Butt"===t,r="Square"===t,n=!a&&!r;e.length%2==1&&(e=[...e,...e]);const s=15.5;let o=0;for(const i of e)o+=i;const l=Math.round(o*s),c=new Float32Array(31*l),h=7.75;let m=0,g=0,u=.5,d=!0;for(const i of e){for(m=g,g+=i*s;u<=g;){let e=.5;for(;e<31;){const t=(e-.5)*l+u-.5,i=n?(e-s)*(e-s):Math.abs(e-s);c[t]=d?a?Math.max(Math.max(m+h-u,i),Math.max(u-g+h,i)):i:n?Math.min((u-m)*(u-m)+i,(u-g)*(u-g)+i):r?Math.min(Math.max(u-m,i),Math.max(g-u,i)):Math.min(Math.max(u-m+h,i),Math.max(g+h-u,i)),e++}u++}d=!d}const f=c.length,y=new Uint8Array(4*f);for(let p=0;p<f;++p){const e=(n?Math.sqrt(c[p]):c[p])/s;(0,i.U)(e,y,4*p)}return[y,l,31]}}}]);
//# sourceMappingURL=305.d79d3681.chunk.js.map